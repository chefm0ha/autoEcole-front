<!-- Main Content Container -->
<div class="container-fluid px-2 px-md-4 pb-2">
  <!-- Header -->
  <div class="mb-4">
    <!-- Title with Status Badge -->
    <div class="d-flex align-items-center gap-2">
      <h4 class="mb-0">
        <svg cIcon name="cilUser" class="me-2"></svg>
        Détails du candidat
      </h4>
      <c-badge [color]="candidate.isActive ? 'success' : 'secondary'" *ngIf="candidate">
        {{ candidate.isActive ? 'Actif' : 'Inactif' }}
      </c-badge>
    </div>
  </div>

<!-- Loading -->
<div *ngIf="loading" class="text-center p-5">
  <c-spinner aria-hidden="true"></c-spinner>
  <p class="mt-2 text-muted">Chargement des détails...</p>
</div>

<!-- Success Alert -->
<c-alert *ngIf="success" color="success" [dismissible]="true" class="mb-4">
  <svg cIcon name="cilCheckCircle" class="me-2"></svg>
  {{ success }}
</c-alert>

<!-- Error Alert -->
<c-alert *ngIf="error" color="danger" [dismissible]="true" class="mb-4">
  <svg cIcon name="cilWarning" class="me-2"></svg>
  {{ error }}
</c-alert>

<!-- Content -->
<div *ngIf="!loading && candidate">
  <c-row class="g-4">
    
    <!-- Personal Information -->
    <c-col [lg]="12">
      <c-card class="h-100">
        <c-card-header class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <svg cIcon name="cilInfo" class="me-2"></svg>
            Informations personnelles
          </h5>
        </c-card-header>
        <c-card-body>          <c-row class="g-3">
            <!-- Row 1: 4 columns -->
            <c-col md="3">
              <strong>CIN:</strong><br>
              <span class="text-primary fw-semibold">{{ candidate.cin }}</span>
            </c-col>
            <c-col md="3">
              <strong>Sexe:</strong><br>
              <span>{{ candidate.gender === 'M' ? 'Homme' : 'Femme' }}</span>
            </c-col>
            <c-col md="3">
              <strong>Prénom:</strong><br>
              <span>{{ candidate.firstName }}</span>
            </c-col>            <c-col md="3">
              <strong>Nom:</strong><br>
              <span>{{ candidate.lastName }}</span>
            </c-col>
            
            <!-- Row 2: 4 columns -->
            <c-col md="3">
              <strong>Date de naissance:</strong><br>
              <span>{{ formatDate(candidate.birthDay) }}</span>
            </c-col>
            <c-col md="3">
              <strong>Lieu de naissance:</strong><br>
              <span>{{ candidate.birthPlace || '-' }}</span>
            </c-col>
            <c-col md="3">
              <strong>Ville:</strong><br>
              <span>{{ candidate.city || '-' }}</span>
            </c-col>
            <c-col md="3">
              <strong>Date d'inscription:</strong><br>
              <span>{{ candidate.startingDate ? formatDate(candidate.startingDate) : '-' }}</span>
            </c-col>
            
            <!-- Row 3: Address full width + Email + Phone -->
            <c-col md="6">
              <strong>Adresse:</strong><br>
              <span>{{ candidate.address || '-' }}</span>
            </c-col>
            <c-col md="3">
              <strong>Email:</strong><br>
              <span>{{ candidate.email || '-' }}</span>
            </c-col>
            <c-col md="3">
              <strong>Téléphone:</strong><br>
              <span>{{ formatPhone(candidate.gsm) }}</span>
            </c-col>
          </c-row>        </c-card-body>
      </c-card>    </c-col>
    <!-- Application Files -->
    <c-col [lg]="12">
      <c-card>
        <c-card-header class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <h5 class="mb-0">
              <svg cIcon name="cilFolder" class="me-2"></svg>
              {{ showArchive ? 'Archives des dossiers' : 'Dossiers de candidature' }}
            </h5>
            <c-badge color="info" *ngIf="!showArchive">{{ applicationFiles.length }} actif(s)</c-badge>
            <c-badge color="secondary" *ngIf="showArchive">{{ archivedApplicationFiles.length }} archivé(s)</c-badge>
          </div>
          <div class="d-flex gap-2">
            <button 
              cButton 
              [color]="showArchive ? 'secondary' : 'ghost'"
              size="sm"
              (click)="toggleArchive()"
              *ngIf="archivedApplicationFiles.length > 0">
              <svg cIcon name="cilHistory" class="me-1"></svg>
              {{ showArchive ? 'Voir actifs' : 'Voir archives' }}
            </button>
            <button 
              cButton 
              color="primary" 
              size="sm" 
              (click)="openApplicationFileModal()"
              *ngIf="!showArchive && (applicationFiles.length === 0 || getCategories().length < categories.length)">
              <svg cIcon name="cilPlus" class="me-1"></svg>
              Ajouter dossier
            </button>
          </div>
        </c-card-header>        <c-card-body>
          <!-- Active Application Files -->
          <div *ngIf="!showArchive">
            <div *ngIf="applicationFiles.length === 0; else hasApplicationFiles">
              <div class="text-center p-5">
                <svg cIcon name="cilFolder" size="3xl" class="text-muted mb-3"></svg>
                <h6 class="text-muted mb-3">Aucun dossier de candidature</h6>
                <p class="text-muted mb-3">Ce candidat n'a pas encore de dossier de candidature.</p>
                <button cButton color="primary" (click)="openApplicationFileModal()">
                  <svg cIcon name="cilPlus" class="me-2"></svg>
                  Créer un dossier
                </button>
              </div>
            </div>            <ng-template #hasApplicationFiles>

              <c-tabs [activeItemKey]="activeTab" (activeItemKeyChange)="onTabChange($event)">
                <c-tabs-list variant="tabs">
                  <button 
                    cTab 
                    *ngFor="let category of getCategories()"
                    [itemKey]="category">
                    <svg cIcon name="cilFile" class="me-2"></svg>
                    Catégorie {{ category }}
                  </button>
                </c-tabs-list>

                <div class="d-flex justify-content-end gap-2" *ngIf="getApplicationFilesByCategory(activeTab || getCategories()[0])">
                <!-- Close Application File Button (Complete) -->
                <button 
                  *ngFor="let file of getApplicationFilesByCategory(activeTab || getCategories()[0]); let i = index"
                  [hidden]="!canCloseApplicationFile(file)"
                  cButton 
                  color="success" 
                  size="sm"
                  (click)="openCloseApplicationFileModal(file)"
                  [title]="'Clôturer le dossier ' + (file.fileNumber || '#' + file.id)"
                  class="fw-medium mt-3 text-white">
                  <svg cIcon name="cilCheckCircle" class="me-1"></svg>
                  Clôturer le dossier
                </button>
                
                <!-- Cancel Application File Button -->
                <button 
                  *ngFor="let file of getApplicationFilesByCategory(activeTab || getCategories()[0]); let i = index"
                  [hidden]="!canCancelApplicationFile(file) || canCloseApplicationFile(file)"
                  cButton 
                  color="danger" 
                  size="sm"
                  (click)="openCancelApplicationFileModal(file)"
                  [title]="'Annuler le dossier ' + (file.fileNumber || '#' + file.id)"
                  class="fw-medium mt-3 text-white">
                  <svg cIcon name="cilX" class="me-1"></svg>
                  Annuler le dossier
                </button>
              </div>
                
                <c-tabs-content>
                  <c-tab-panel
                    *ngFor="let category of getCategories()"
                    [itemKey]="category"
                    class="p-3">
                      <div>
                    <!-- Application Files for this category -->
                    <div *ngFor="let file of getApplicationFilesByCategory(category)" class="mb-5">
                      
                      <!-- Three Sections in Horizontal Layout -->
                      <div class="row g-3">
                        
                        <!-- Column 1: Candidate Info -->
                        <div class="col-lg-4">
                          <div class="border rounded p-4 h-100 themed-card" [class]="getApplicationFileBorderColor(file)">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                              <div class="d-flex align-items-center gap-2">
                                <span class="text-dark fw-semibold fs-5">{{ file.fileNumber || 'Dossier #' + file.id }}</span>
                              </div>
                              <c-badge [color]="file.status === 'ACTIVE' || file.status === 'IN_PROGRESS' || file.status === 'COMPLETED' || file.status === 'GRADUATED' ? 'success' : file.status === 'FAILED' || file.status === 'CANCELLED' ? 'danger' : file.status === 'EXPIRED' ? 'warning' : 'secondary'">
                                {{ getApplicationFileStatusLabel(file.status) }}
                              </c-badge>
                            </div>

                            <div class="text-center mb-5">
                              <p class="text-muted small mb-0">Créé le {{ formatDate(file.startingDate) }}</p>
                            </div>
                            
                            <!-- Theoretical Hours Circle -->
                            <div class="text-center mb-5">
                              <div class="position-relative d-inline-block">
                                <div class="theoretical-hours-circle mx-auto d-flex align-items-center justify-content-center flex-column" 
                                     [style.background]="'conic-gradient(#28a745 0deg ' + (file.theoreticalHoursCompleted / 20 * 360) + 'deg, #e9ecef ' + (file.theoreticalHoursCompleted / 20 * 360) + 'deg 360deg)'">
                                  <div class="theoretical-hours-inner d-flex align-items-center justify-content-center flex-column">
                                    <div class="fw-bold fs-4">{{ file.theoreticalHoursCompleted }}/20</div>
                                  </div>
                                </div>
                              </div>
                              <div class="d-flex align-items-center justify-content-center gap-2 mt-3">
                                <small class="text-muted">Heures théoriques</small>
                                <button 
                                  cButton 
                                  variant="ghost" 
                                  size="sm" 
                                  (click)="openEditHoursModal(file, 'theoretical')"
                                  class="p-1">
                                  <svg cIcon name="cilPencil" size="sm"></svg>
                                </button>
                              </div>
                            </div>
                            
                            <!-- Status Buttons -->
                            <div class="d-flex flex-column align-items-center gap-3">
                              <button 
                                cButton 
                                size="sm"
                                (click)="openTaxStampModal(file)"
                                [disabled]="file.taxStamp === 'PAID'"
                                class="status-button tax-stamp-button text-center w-100 force-text-white"
                                [ngClass]="{
                                  'status-paid': file.taxStamp === 'PAID',
                                  'status-pending': file.taxStamp === 'PENDING',
                                  'status-not-paid': file.taxStamp === 'NOT_PAID'
                                }">
                                <div class="d-flex align-items-center justify-content-between w-100">
                                  <div class="text-center flex-grow-1">
                                    <div class="fw-semibold">
                                      {{ file.taxStamp === 'PAID' 
                                        ? 'Timbre fiscal payé'
                                        : (file.taxStamp === 'PENDING' 
                                          ? 'Le timbre fiscal doit être payé'
                                          : 'Le timbre fiscal doit être payé') }}
                                    </div>
                                  </div>
                                  <svg *ngIf="file.taxStamp !== 'PAID'" cIcon name="cilPencil" size="sm" class="edit-icon"></svg>
                                </div>
                              </button>
                              <button 
                                cButton 
                                size="sm"
                                (click)="openMedicalVisitModal(file)"
                                [disabled]="file.medicalVisit === 'COMPLETED'"
                                class="status-button medical-visit-button text-center w-100 force-white-text"
                                [ngClass]="{
                                  'status-completed': file.medicalVisit === 'COMPLETED',
                                  'status-pending': file.medicalVisit === 'PENDING',
                                  'status-not-requested': file.medicalVisit === 'NOT_REQUESTED'
                                }">
                                <div class="d-flex align-items-center justify-content-between w-100">
                                  <div class="text-center flex-grow-1">
                                    <div class="fw-semibold">
                                      {{ file.medicalVisit === 'COMPLETED' 
                                        ? 'Visite médicale validée'
                                        : (file.medicalVisit === 'PENDING' 
                                          ? 'La visite médicale doit être validée'
                                          : 'La visite médicale doit être validée') }}
                                    </div>
                                  </div>
                                  <svg *ngIf="file.medicalVisit !== 'COMPLETED'" cIcon name="cilPencil" size="sm" class="edit-icon"></svg>
                                </div>
                              </button>
                            </div>
                          </div>
                        </div>

                        <!-- Column 2: Payment Section -->
                        <div class="col-lg-4">
                          <div class="border rounded p-4 h-100 themed-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                              <h6 class="mb-0 fs-5 text-dark">
                                Paiements
                              </h6>
                              <button 
                                cButton 
                                color="success" 
                                size="sm" 
                                (click)="openPaymentModal(file)"
                                *ngIf="file.payment && file.payment.status !== 'COMPLETED'"
                                class="text-white">
                                <svg cIcon name="cilPlus" class="me-1"></svg>
                                Ajouter paiement
                              </button>
                            </div>
                            
                            <div *ngIf="file.payment" class="mt-3">
                              <!-- Large Centered Payment Amount -->
                              <div class="text-center mb-1">
                                <div class="display-4 fw-bold text-success">{{ file.payment.paidAmount }}</div>
                              </div>
                              
                              <!-- Progress Bar -->
                              <div class="mb-3">
                                <c-progress size="sm">
                                  <c-progress-bar 
                                    [value]="getPaymentProgress(file)" 
                                    [color]="file.payment.status === 'COMPLETED' ? 'success' : 'warning'">
                                  </c-progress-bar>
                                </c-progress>
                              </div>
                              
                              <div class="d-flex align-items-center justify-content-between mb-4">
                                <div></div>
                                <div class="fs-6 text-muted text-center">/ {{ file.payment.totalAmount }} MAD</div>
                                <c-badge 
                                  [color]="file.payment.status === 'COMPLETED' ? 'success' : file.payment.status === 'PENDING' ? 'warning' : 'secondary'"
                                  size="sm">
                                  {{ file.payment.status === 'COMPLETED' ? 'Payé' : file.payment.status === 'PENDING' ? 'Partiel' : 'Non payé' }}
                                </c-badge>
                              </div>
                              <!-- Payment History -->
                              <div *ngIf="file.payment.installments.length > 0">
                                <small class="text-muted d-block mb-3 fw-semibold">Historique de payment</small>
                                <div class="d-flex flex-column gap-2" style="max-height: 280px; overflow-y: auto;">
                                  <div *ngFor="let installment of file.payment.installments" 
                                    class="p-3 border rounded shadow-sm border-2 payment-installment themed-surface">
                                    <div class="d-flex justify-content-between align-items-center">
                                      <div class="d-flex flex-column">
                                        <span class="fw-semibold mb-2 text-primary">Paiement {{ installment.installmentNumber }}</span>
                                        <small class="text-muted">{{ formatDate(installment.date) }}</small>
                                      </div>
                                      <div class="text-end d-flex flex-column align-items-end gap-1">
                                        <span class="fw-bold text-success fs-5">{{ installment.amount }} MAD</span>
                                        <c-badge [color]="getInstallmentStatusColor(installment.status)" size="sm">
                                          {{ getInstallmentStatusLabel(installment.status) }}
                                        </c-badge>
                                        <button 
                                          *ngIf="isAdmin() && installment.status === 'PENDING'" 
                                          cButton 
                                          color="success" 
                                          size="sm" 
                                          (click)="validateInstallment(installment.id, file)"
                                          [disabled]="loading"
                                          class="force-white-text">
                                          <c-spinner *ngIf="loading" size="sm" class="me-1"></c-spinner>
                                          Valider
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            <div *ngIf="!file.payment" class="text-center p-3">
                              <svg cIcon name="cilCreditCard" size="xl" class="text-muted mb-2"></svg>
                              <div class="text-muted small">Aucun paiement enregistré</div>
                            </div>
                          </div>
                        </div>

                        <!-- Column 3: Exams Section -->
                        <div class="col-lg-4">
                          <div class="border rounded p-4 h-100 themed-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                              <h6 class="mb-0 fs-5 text-dark">
                                Examens
                              </h6>
                              <button 
                                cButton 
                                color="warning" 
                                size="sm" 
                                (click)="openExamModal(file.category, file)"
                                [disabled]="!isApplicationFileEligibleForExams(file) || getApplicationFileRemainingAttempts(file) === 0 || hasGraduated(file) || hasScheduledExam(file)"
                                class="text-white">
                                <svg cIcon name="cilPlus" class="me-1"></svg>
                                Ajouter examen
                              </button>
                            </div>
                            
                            <div *ngIf="!isApplicationFileEligibleForExams(file)" class="alert alert-warning p-2 mb-3">
                              <small><strong>Prérequis manquants :</strong></small>
                              <ul class="mb-0 mt-1 small">
                                <li *ngFor="let prerequisite of getFilteredExamPrerequisites(file)" class="text-muted">
                                  {{ prerequisite }}
                                </li>
                              </ul>
                            </div>
                            
                            <div *ngIf="file.exams && file.exams.length > 0; else noExams">
                              <div class="d-flex flex-column gap-2">
                                <div *ngFor="let exam of file.exams" class="border rounded p-2" 
                                     [class.border-success]="exam.status === 'PASSED'"
                                     [class.bg-success-subtle]="exam.status === 'PASSED'"
                                     [class.border-danger]="exam.status === 'FAILED'"
                                     [class.bg-danger-subtle]="exam.status === 'FAILED'"
                                     [class.border-warning]="exam.status === 'SCHEDULED'"
                                     [class.bg-warning-subtle]="exam.status === 'SCHEDULED'">
                                  <div class="d-flex justify-content-between align-items-start mb-1">
                                    <c-badge 
                                      [color]="exam.examType === 'THEORY' ? 'info' : 'primary'" 
                                      size="sm">
                                      {{ exam.examType === 'THEORY' ? 'Théorique' : 'Pratique' }}
                                    </c-badge>
                                    <div class="d-flex align-items-center gap-1">
                                      <c-badge 
                                        [color]="exam.status === 'PASSED' ? 'success' : exam.status === 'FAILED' ? 'danger' : 'warning'"
                                        size="sm">
                                        {{ exam.status === 'PASSED' ? 'Réussi' : exam.status === 'FAILED' ? 'Échoué' : 'Programmé' }}
                                      </c-badge>
                                      <button 
                                        cButton 
                                        variant="ghost" 
                                        size="sm"
                                        class="p-1 lh-1 exam-edit-button"
                                        [disabled]="exam.status === 'PASSED' || exam.status === 'FAILED'"
                                        (click)="handleExamStatusEdit(exam)"
                                        [title]="getExamEditTooltip(exam)">
                                        <svg cIcon name="cilPencil" size="sm"></svg>
                                      </button>
                                    </div>
                                  </div>
                                  <div class="text-center">
                                    <div class="fw-semibold small">{{ formatDate(exam.date) }}</div>
                                    <small class="text-muted">Tentative #{{ exam.attemptNumber }}</small>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            <ng-template #noExams>
                              <div class="text-center p-3">
                                <svg cIcon name="cilTask" size="xl" class="text-muted mb-2"></svg>
                                <div class="text-muted small">Aucun examen programmé</div>
                              </div>
                            </ng-template>
                          </div>
                        </div>
                        
                      </div>
                    </div></div>
                  </c-tab-panel>
                </c-tabs-content>
              </c-tabs>
            </ng-template>
          </div>

          <!-- Archive Section -->
          <div *ngIf="showArchive">
            <div *ngIf="archivedApplicationFiles.length === 0" class="text-center p-5">
              <svg cIcon name="cilHistory" size="3xl" class="text-muted mb-3"></svg>
              <h6 class="text-muted mb-3">Aucun dossier archivé</h6>
              <p class="text-muted mb-0">Tous les dossiers expirés apparaîtront ici.</p>
            </div>
            
            <div *ngIf="archivedApplicationFiles.length > 0">
              <c-tabs [activeItemKey]="activeTab" (activeItemKeyChange)="onTabChange($event)">
                <c-tabs-list variant="tabs">
                  <button 
                    cTab 
                    *ngFor="let category of getArchivedCategories()"
                    [itemKey]="category">
                    <svg cIcon name="cilHistory" class="me-2"></svg>
                    Catégorie {{ category }}
                    <c-badge color="secondary" class="ms-2">{{ getArchivedApplicationFilesByCategory(category).length }}</c-badge>
                  </button>
                </c-tabs-list>
                
                <c-tabs-content>
                  <c-tab-panel 
                    *ngFor="let category of getArchivedCategories()" 
                    [itemKey]="category"
                    class="p-3">
                    
                    <div class="row g-3">
                      <div *ngFor="let file of getArchivedApplicationFilesByCategory(category)" class="col-12 col-lg-6">
                        <c-card class="border-secondary h-100 opacity-75">                          <c-card-body>
                            <div class="d-flex align-items-start mb-3">
                              <h6 class="mb-0 text-muted">{{ file.fileNumber || 'Dossier #' + file.id }}</h6>
                            </div>
                            
                            <p class="text-muted small mb-2">
                              Créé le {{ formatDate(file.startingDate) }}
                            </p>
                            <div class="row g-2 mb-3">
                              <div class="col-6">
                                <small class="text-muted">Timbre fiscal :
                                  <c-badge [color]="getTaxStampColor(file.taxStamp)" size="sm">
                                    {{ getTaxStampLabel(file.taxStamp) }}
                                  </c-badge>
                                </small>
                              </div>
                              <div class="col-12">
                                <small class="text-muted">Visite médicale : 
                                  <c-badge 
                                    [color]="getMedicalVisitColor(file.medicalVisit)" 
                                    size="sm">
                                    {{ getMedicalVisitLabel(file.medicalVisit) }}
                                  </c-badge>
                                </small>
                              </div>
                            </div>
                            
                            <!-- Archived Payment Section -->
                            <div class="border-top pt-3 mt-3">
                              <h6 class="mb-2 text-muted">
                                <svg cIcon name="cilCreditCard" class="me-2"></svg>
                                Paiement final
                              </h6>
                              
                              <div *ngIf="file.payment" class="mb-2">
                                <div class="d-flex justify-content-between text-sm mb-1">
                                  <span class="text-muted">{{ file.payment.paidAmount }} / {{ file.payment.totalAmount }} MAD</span>                                  <c-badge 
                                    [color]="file.payment.status === 'COMPLETED' ? 'success' : 'secondary'"
                                    size="sm">
                                    {{ file.payment.status === 'COMPLETED' ? 'Payé' : 'Incomplet' }}
                                  </c-badge>
                                </div>
                                <c-progress size="xs">
                                  <c-progress-bar 
                                    [value]="getPaymentProgress(file)" 
                                    color="secondary">
                                  </c-progress-bar>
                                </c-progress>
                              </div>
                            </div>
                            
                            <!-- Exams Section for this Application File -->
                            <div class="border-top pt-3 mt-3" *ngIf="file.exams && file.exams.length > 0">
                              <h6 class="mb-2">
                                <svg cIcon name="cilTask" class="me-2"></svg>
                                Examens ({{ file.exams.length }})
                              </h6>
                              <div class="row g-1">
                                <div *ngFor="let exam of file.exams" class="col-12">
                                  <div class="d-flex justify-content-between align-items-center p-2 border rounded">                                    <div>
                                      <c-badge 
                                        [color]="exam.examType === 'THEORY' ? 'info' : 'primary'" 
                                        size="sm" 
                                        class="me-2">
                                        {{ exam.examType === 'THEORY' ? 'Théorique' : 'Pratique' }}
                                      </c-badge>
                                      <small class="text-muted">{{ formatDate(exam.date) }}</small>
                                    </div>
                                    <c-badge 
                                      [color]="exam.status === 'PASSED' ? 'success' : exam.status === 'FAILED' ? 'danger' : 'warning'"
                                      size="sm">
                                      {{ exam.status === 'PASSED' ? 'Réussi' : exam.status === 'FAILED' ? 'Échoué' : 'Programmé' }}
                                    </c-badge>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </c-card-body>
                        </c-card>
                      </div>
                    </div>
                  </c-tab-panel>
                </c-tabs-content>
              </c-tabs>
            </div>
          </div>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
</div>
<!-- End Main Content Container -->

<!-- MODALS START HERE -->

<!-- Application File Modal -->
<c-modal 
  [visible]="showApplicationFileModal" 
  (visibleChange)="showApplicationFileModal = $event"
  [keyboard]="false"
  [backdrop]="'static'">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilFolder" class="me-2"></svg>
      Créer un dossier de candidature
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeApplicationFileModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="success" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ success }}
    </c-alert>

    <c-alert *ngIf="error" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ error }}
    </c-alert>    <form [formGroup]="applicationFileForm" cForm>
      <c-row class="g-3">        <c-col md="12">
          <label cLabel for="category">Catégorie *</label>
          <select 
            cSelect 
            id="category" 
            formControlName="category"
            [class.is-invalid]="isFieldInvalid(applicationFileForm, 'category')">
            <option value="">Choisir une catégorie...</option>
            <option *ngFor="let cat of categories" [value]="cat.code">
              {{ cat.code }} - {{ cat.description }}
            </option>
          </select>
          <c-form-feedback 
            *ngIf="isFieldInvalid(applicationFileForm, 'category')" 
            [valid]="false">
            {{ getFieldError(applicationFileForm, 'category') }}
          </c-form-feedback>
        </c-col>
        
        <c-col md="6">
          <label cLabel for="totalAmount">Montant total *</label>
          <c-input-group>
            <input 
              cFormControl 
              id="totalAmount" 
              type="number" 
              formControlName="totalAmount"
              placeholder="0"
              [class.is-invalid]="isFieldInvalid(applicationFileForm, 'totalAmount')">
            <span cInputGroupText>MAD</span>
          </c-input-group>
          <c-form-feedback 
            *ngIf="isFieldInvalid(applicationFileForm, 'totalAmount')" 
            [valid]="false">
            {{ getFieldError(applicationFileForm, 'totalAmount') }}
          </c-form-feedback>
        </c-col>
        
        <c-col md="6">
          <label cLabel for="initialAmount">Montant initial *</label>
          <c-input-group>
            <input 
              cFormControl 
              id="initialAmount" 
              type="number" 
              formControlName="initialAmount"
              [placeholder]="applicationFileForm.get('totalAmount')?.value ? 'Max: ' + applicationFileForm.get('totalAmount')?.value + ' MAD' : '0'"
              [max]="applicationFileForm.get('totalAmount')?.value || 0"
              step="0.01"
              [class.is-invalid]="isFieldInvalid(applicationFileForm, 'initialAmount')">
            <span cInputGroupText>MAD</span>
          </c-input-group>
          <c-form-feedback 
            *ngIf="isFieldInvalid(applicationFileForm, 'initialAmount')" 
            [valid]="false">
            {{ getFieldError(applicationFileForm, 'initialAmount') }}
          </c-form-feedback>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeApplicationFileModal()">
      Annuler
    </button>
    <button 
      cButton 
      color="primary" 
      [disabled]="applicationFileForm.invalid || loading"
      (click)="onSubmitApplicationFile()">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Créer le dossier
    </button>
  </c-modal-footer>
</c-modal>
<!-- Exam Modal -->
<c-modal 
  [visible]="showExamModal" 
  (visibleChange)="showExamModal = $event"
  [keyboard]="false"
  [backdrop]="'static'"
  size="lg">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilTask" class="me-2"></svg>
      Ajouter un examen
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeExamModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="success" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ success }}
    </c-alert>

    <c-alert *ngIf="error" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ error }}
    </c-alert>

    <!-- Application File Info -->
    <div *ngIf="selectedApplicationFile" class="alert alert-info mb-3">
      <h6 class="mb-2">
        <svg cIcon name="cilInfo" class="me-2"></svg>
        Dossier de candidature
      </h6>
      <div class="row g-2">        <div class="col-md-4">
          <strong>Catégorie:</strong> {{ selectedApplicationFile.category }}
        </div>
        <div class="col-md-4">
          <strong>Dossier:</strong> {{ selectedApplicationFile.fileNumber || '#' + selectedApplicationFile.id }}
        </div>
        <div class="col-md-4">
          <strong>Tentatives restantes:</strong> 
          <c-badge color="info" size="sm" class="ms-1">
            {{ getApplicationFileRemainingAttempts(selectedApplicationFile) }} sur 3
          </c-badge>        </div>
      </div>
    </div>

    <form [formGroup]="examForm" cForm>
      <c-row class="g-3">        <c-col md="6">
          <label cLabel for="examType">Type d'examen</label>
          <div class="mt-2">
            <span class="fw-bold fs-5">
              {{ getExamTypeIcon(examForm.get('examType')?.value) }} 
              {{ getExamTypeLabel(examForm.get('examType')?.value) }}
            </span>
          </div>
        </c-col>
        
        <c-col md="6">
          <label cLabel for="examDate">Date de l'examen *</label>
          <input 
            cFormControl 
            id="examDate" 
            type="date" 
            formControlName="date"
            class="form-control"
            [min]="getMinDateForExam(selectedApplicationFile)"
            [class.is-invalid]="isFieldInvalid(examForm, 'date')">
          <c-form-feedback 
            *ngIf="isFieldInvalid(examForm, 'date')" 
            [valid]="false">
            {{ getFieldError(examForm, 'date') }}
          </c-form-feedback>
        </c-col>
        
        <c-col md="12">
          <label cLabel for="examStatus">Statut de l'examen *</label>
          <select 
            cFormSelect 
            id="examStatus" 
            formControlName="status"
            class="form-select"
            [class.is-invalid]="isFieldInvalid(examForm, 'status')">
            <option value="" disabled>Choisir le statut</option>
            <option value="SCHEDULED">📅 Programmé</option>
            <option value="PASSED">✅ Réussi</option>
            <option value="FAILED">❌ Échoué</option>
          </select>
          <c-form-feedback 
            *ngIf="isFieldInvalid(examForm, 'status')" 
            [valid]="false">
            {{ getFieldError(examForm, 'status') }}
          </c-form-feedback>
        </c-col>

        <!-- Vehicle selection for practical exams -->
        <c-col md="12" *ngIf="examForm.get('examType')?.value === 'PRACTICAL'">
          <label cLabel for="vehicleSelect">Véhicule *</label>
          <select 
            cFormSelect 
            id="vehicleSelect" 
            formControlName="immatriculation"
            class="form-select"
            [class.is-invalid]="isFieldInvalid(examForm, 'immatriculation')">
            <option value="" disabled>Choisir un véhicule</option>
            <option 
              *ngFor="let vehicle of availableVehicles" 
              [value]="vehicle.immatriculation"
              [disabled]="!isVehicleAvailable(vehicle)"
              [ngClass]="{
                'text-muted': !isVehicleAvailable(vehicle),
                'fw-bold': isVehicleAvailable(vehicle)
              }">
              {{ vehicle.immatriculation }} - {{ vehicle.vehicleBrand || 'N/A' }}
              <span *ngIf="!isVehicleAvailable(vehicle)" class="text-muted"> - Quota épouisé</span>
            </option>
          </select>
          <c-form-feedback 
            *ngIf="isFieldInvalid(examForm, 'immatriculation')" 
            [valid]="false">
            {{ getFieldError(examForm, 'immatriculation') }}
          </c-form-feedback>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
    <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeExamModal()">
      Annuler
    </button>    <button 
      cButton 
      color="primary" 
      (click)="onSubmitExam()"
      [disabled]="loading || !examForm.get('examType')?.value || examForm.get('date')?.invalid || examForm.get('status')?.invalid || (examForm.get('examType')?.value === 'PRACTICAL' && examForm.get('immatriculation')?.invalid)">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Enregistrer l'examen
    </button>
  </c-modal-footer>
</c-modal>

<!-- Payment Modal -->
<c-modal 
  [visible]="showPaymentModal" 
  (visibleChange)="showPaymentModal = $event"
  [keyboard]="false"
  [backdrop]="'static'">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilCreditCard" class="me-2"></svg>
      Ajouter un paiement
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closePaymentModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="success" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ success }}
    </c-alert>

    <c-alert *ngIf="error" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ error }}
    </c-alert>

    <!-- Application File Info -->
    <div *ngIf="selectedApplicationFile" class="alert alert-info mb-3">
      <h6 class="mb-2">
        <svg cIcon name="cilInfo" class="me-2"></svg>
        Dossier de candidature
      </h6>
      <div class="row g-2">
        <div class="col-6">
          <strong>Catégorie:</strong> {{ selectedApplicationFile.category }}
        </div>        <div class="col-6">
          <strong>Dossier:</strong> {{ selectedApplicationFile.fileNumber || '#' + selectedApplicationFile.id }}
        </div><div class="col-6">
          <strong>Total:</strong> {{ selectedApplicationFile.payment?.totalAmount || 0 }} MAD
        </div>
        <div class="col-6">
          <strong>Déjà payé:</strong> {{ selectedApplicationFile.payment?.paidAmount || 0 }} MAD
        </div>
        <div class="col-12">
          <strong>Reste à payer:</strong> 
          <span [class]="getRemainingPayment(selectedApplicationFile) > 0 ? 'text-danger fw-bold' : 'text-success fw-bold'">
            {{ getRemainingPayment(selectedApplicationFile) }} MAD
          </span>
          <span *ngIf="getRemainingPayment(selectedApplicationFile) === 0" class="text-success ms-2">
            ✓ Paiement complet
          </span>
        </div>
      </div>
    </div>

    <!-- Payment already complete message -->
    <c-alert *ngIf="selectedApplicationFile && getRemainingPayment(selectedApplicationFile) === 0" color="success" class="mb-3">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      Le paiement de ce dossier est déjà complet. Aucun paiement supplémentaire n'est nécessaire.
    </c-alert>    <!-- Payment Form - only show if remaining amount > 0 -->
    <form [formGroup]="paymentForm" cForm *ngIf="selectedApplicationFile && getRemainingPayment(selectedApplicationFile) > 0">
      <c-row class="g-3">
        <c-col md="12">
          <label cLabel for="paymentAmount">Montant *</label>
          <c-input-group>
            <input 
              cFormControl 
              id="paymentAmount" 
              type="number" 
              formControlName="amount"
              [placeholder]="'Saisissez un montant (max: ' + getRemainingPayment(selectedApplicationFile) + ' MAD)'"
              [max]="getRemainingPayment(selectedApplicationFile)"
              step="0.01"
              [class.is-invalid]="isFieldInvalid(paymentForm, 'amount')">
            <span cInputGroupText>MAD</span>
          </c-input-group>
          <c-form-feedback 
            *ngIf="isFieldInvalid(paymentForm, 'amount')" 
            [valid]="false">
            {{ getFieldError(paymentForm, 'amount') }}
          </c-form-feedback>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closePaymentModal()">
      Annuler
    </button>    <button 
      cButton 
      color="primary" 
      *ngIf="selectedApplicationFile && getRemainingPayment(selectedApplicationFile) > 0"
      [disabled]="paymentForm.invalid || loading"
      (click)="onSubmitPayment()">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Enregistrer le paiement
    </button>  </c-modal-footer>
</c-modal>

<!-- Tax Stamp Status Modal -->
<c-modal 
  [visible]="showTaxStampModal" 
  (visibleChange)="showTaxStampModal = $event"
  [keyboard]="false"
  [backdrop]="'static'"
  size="lg">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilCreditCard" class="me-2"></svg>
      Modifier le statut du timbre fiscal
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeTaxStampModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="success" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ success }}
    </c-alert>

    <c-alert *ngIf="error" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ error }}
    </c-alert>    <!-- Application File Info -->
    <div *ngIf="selectedApplicationFileForStatus" class="alert alert-info mb-3">
      <h6 class="mb-2">
        <svg cIcon name="cilInfo" class="me-2"></svg>
        Dossier de candidature
      </h6>
      <div class="row g-2">
        <div class="col-md-4">
          <strong>Catégorie:</strong> {{ selectedApplicationFileForStatus.category }}
        </div>
        <div class="col-md-4">
          <strong>Dossier:</strong> {{ selectedApplicationFileForStatus.fileNumber || '#' + selectedApplicationFileForStatus.id }}
        </div>
        <div class="col-md-4">
          <strong>Statut actuel:</strong> 
          <c-badge [color]="getTaxStampColor(selectedApplicationFileForStatus.taxStamp)" size="sm" class="ms-1">
            {{ getTaxStampLabel(selectedApplicationFileForStatus.taxStamp) }}
          </c-badge>
        </div>
      </div>
    </div>    <form [formGroup]="taxStampForm" cForm>
      <c-row class="g-3">
        <c-col md="12">
          <label cLabel for="taxStampStatus">Nouveau statut *</label>
          <select 
            cFormSelect 
            id="taxStampStatus"
            formControlName="status"
            class="form-select"
            [class.is-invalid]="isFieldInvalid(taxStampForm, 'status')">
            <option value="" disabled>Sélectionner un statut</option>
            <option value="NOT_PAID">❌ Non payé</option>
            <option value="PENDING">⏳ En attente</option>
            <option value="PAID">✅ Payé</option>
          </select>
          <c-form-feedback 
            *ngIf="isFieldInvalid(taxStampForm, 'status')" 
            [valid]="false">
            {{ getFieldError(taxStampForm, 'status') }}
          </c-form-feedback>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeTaxStampModal()">
      Annuler
    </button>
    <button 
      cButton 
      color="primary" 
      (click)="onSubmitTaxStamp()"
      [disabled]="loading">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Mettre à jour
    </button>
  </c-modal-footer>
</c-modal>

<!-- Medical Visit Status Modal -->
<c-modal 
  [visible]="showMedicalVisitModal" 
  (visibleChange)="showMedicalVisitModal = $event"
  [keyboard]="false"
  [backdrop]="'static'"
  size="lg">
  <c-modal-header>    <h4 cModalTitle>
      <svg cIcon name="cilPlus" class="me-2"></svg>
      Modifier le statut de la visite médicale
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeMedicalVisitModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="success" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ success }}
    </c-alert>

    <c-alert *ngIf="error" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ error }}
    </c-alert>    <!-- Application File Info -->
    <div *ngIf="selectedApplicationFileForStatus" class="alert alert-info mb-3">
      <h6 class="mb-2">
        <svg cIcon name="cilInfo" class="me-2"></svg>
        Dossier de candidature
      </h6>
      <div class="row g-2">
        <div class="col-md-4">
          <strong>Catégorie:</strong> {{ selectedApplicationFileForStatus.category }}
        </div>
        <div class="col-md-4">
          <strong>Dossier:</strong> {{ selectedApplicationFileForStatus.fileNumber || '#' + selectedApplicationFileForStatus.id }}
        </div>
        <div class="col-md-4">
          <strong>Statut actuel:</strong> 
          <c-badge [color]="getMedicalVisitColor(selectedApplicationFileForStatus.medicalVisit)" size="sm" class="ms-1">
            {{ getMedicalVisitLabel(selectedApplicationFileForStatus.medicalVisit) }}
          </c-badge>
        </div>
      </div>
    </div>    <form [formGroup]="medicalVisitForm" cForm>
      <c-row class="g-3">
        <c-col md="12">
          <label cLabel for="medicalVisitStatus">Nouveau statut *</label>
          <select 
            cFormSelect 
            id="medicalVisitStatus"
            formControlName="status"
            class="form-select"
            [class.is-invalid]="isFieldInvalid(medicalVisitForm, 'status')">
            <option value="" disabled>Sélectionner un statut</option>
            <option value="NOT_REQUESTED">⚪ Pas encore demandé</option>
            <option value="PENDING">⏳ En attente</option>
            <option value="COMPLETED">✅ Validée</option>
          </select>
          <c-form-feedback 
            *ngIf="isFieldInvalid(medicalVisitForm, 'status')" 
            [valid]="false">
            {{ getFieldError(medicalVisitForm, 'status') }}
          </c-form-feedback>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeMedicalVisitModal()">
      Annuler
    </button>
    <button 
      cButton 
      color="primary" 
      (click)="onSubmitMedicalVisit()"
      [disabled]="loading">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Mettre à jour
    </button>  </c-modal-footer>
</c-modal>

<!-- Exam Status Modal -->
<c-modal 
  [visible]="showExamStatusModal" 
  (visibleChange)="showExamStatusModal = $event"
  [keyboard]="false"
  [backdrop]="'static'"
  size="lg">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilTask" class="me-2"></svg>
      Modifier le statut de l'examen
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeExamStatusModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="success" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ success }}
    </c-alert>

    <c-alert *ngIf="error" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ error }}
    </c-alert>

    <!-- Exam Info -->
    <div *ngIf="selectedExam" class="alert alert-info mb-3">
      <h6 class="mb-2">
        <svg cIcon name="cilInfo" class="me-2"></svg>
        Informations de l'examen
      </h6>
      <div class="row g-2">
        <div class="col-md-3">
          <strong>Type:</strong> 
          <c-badge [color]="selectedExam.examType === 'THEORY' ? 'info' : 'primary'" size="sm" class="ms-1">
            {{ selectedExam.examType === 'THEORY' ? 'Théorique' : 'Pratique' }}
          </c-badge>
        </div>
        <div class="col-md-3">
          <strong>Date:</strong> {{ formatDate(selectedExam.date) }}
        </div>
        <div class="col-md-3">
          <strong>Tentative:</strong> #{{ selectedExam.attemptNumber }}
        </div>
        <div class="col-md-3">
          <strong>Statut actuel:</strong> 
          <c-badge [color]="selectedExam.status === 'PASSED' ? 'success' : selectedExam.status === 'FAILED' ? 'danger' : 'warning'" size="sm" class="ms-1">
            {{ selectedExam.status === 'PASSED' ? 'Réussi' : selectedExam.status === 'FAILED' ? 'Échoué' : 'Programmé' }}
          </c-badge>
        </div>
      </div>
    </div>

    <form [formGroup]="examStatusForm" cForm>
      <c-row class="g-3">        <c-col md="12">
          <label cLabel for="examStatus">Nouveau statut *</label>
          <select 
            cFormSelect 
            id="examStatus"
            formControlName="status"
            class="form-select"
            [class.is-invalid]="isFieldInvalid(examStatusForm, 'status')">
            <option value="" disabled>Sélectionner un statut</option>
            <option value="SCHEDULED">📅 Programmé</option>
            <option value="PASSED">✅ Réussi</option>
            <option value="FAILED">❌ Échoué</option>
          </select>
          <c-form-feedback 
            *ngIf="isFieldInvalid(examStatusForm, 'status')" 
            [valid]="false">
            {{ getFieldError(examStatusForm, 'status') }}
          </c-form-feedback>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeExamStatusModal()">
      Annuler
    </button>
    <button 
      cButton 
      color="primary" 
      (click)="onSubmitExamStatus()"
      [disabled]="loading">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Mettre à jour
    </button>  </c-modal-footer>
</c-modal>

<!-- Cancel Application File Modal -->
<c-modal 
  [visible]="showCancelApplicationFileModal"
  (visibleChange)="showCancelApplicationFileModal = $event"  [keyboard]="false"
  [backdrop]="'static'">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilWarning" class="me-2 text-danger"></svg>
      Confirmer l'annulation
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeCancelApplicationFileModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="success" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ success }}
    </c-alert>

    <c-alert *ngIf="error" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ error }}
    </c-alert>

    <div *ngIf="selectedApplicationFileForCancellation" class="alert alert-warning mb-3">
      <p class="mb-1">
        <strong>Catégorie:</strong> {{ selectedApplicationFileForCancellation.category }}
      </p>
      <p class="mb-1">
        <strong>Numéro:</strong> {{ selectedApplicationFileForCancellation.fileNumber || '#' + selectedApplicationFileForCancellation.id }}
      </p>
      <p class="mb-0">
        <strong>Statut actuel:</strong> 
        <c-badge [color]="selectedApplicationFileForCancellation.status === 'ACTIVE' || selectedApplicationFileForCancellation.status === 'IN_PROGRESS' || selectedApplicationFileForCancellation.status === 'COMPLETED' ? 'success' : 'secondary'">
          {{ 
            selectedApplicationFileForCancellation.status === 'ACTIVE' ? 'Actif' : 
            selectedApplicationFileForCancellation.status === 'IN_PROGRESS' ? 'En cours' :
            selectedApplicationFileForCancellation.status === 'COMPLETED' ? 'Réussi' :
            selectedApplicationFileForCancellation.status === 'CANCELLED' ? 'Annulé' :
            selectedApplicationFileForCancellation.status === 'GRADUATED' ? 'Diplômé' :
            selectedApplicationFileForCancellation.status === 'FAILED' ? 'Échoué' :
            'Expiré' 
          }}
        </c-badge>
      </p>
    </div>

    <div class="alert alert-danger">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      <strong>Attention !</strong> Cette action est irréversible. L'annulation du dossier entraînera :
      <ul class="mt-2 mb-0">
        <li>L'arrêt immédiat de tous les examens programmés</li>
        <li>La désactivation définitive du dossier</li>
        <li>L'impossibilité de continuer les formations dans cette catégorie</li>
      </ul>
    </div>

    <p>Êtes-vous sûr de vouloir annuler ce dossier de candidature ?</p>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeCancelApplicationFileModal()">
      Non, garder le dossier
    </button>
    <button 
      cButton 
      color="danger" 
      (click)="onCancelApplicationFile()"
      [disabled]="loading"
      class="d-flex align-items-center text-white">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Oui, annuler le dossier
    </button>
  </c-modal-footer>
</c-modal>

<!-- Close Application File Modal -->
<c-modal 
  [visible]="showCloseApplicationFileModal"
  (visibleChange)="showCloseApplicationFileModal = $event"
  [keyboard]="false"
  [backdrop]="'static'">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      Clôturer le dossier de candidature
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeCloseApplicationFileModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <div *ngIf="selectedApplicationFileForClose" class="alert alert-info mb-3">
      <h6><strong>Dossier à clôturer:</strong></h6>
      <p class="mb-1">
        <strong>Catégorie:</strong> {{ selectedApplicationFileForClose.category }}
      </p>
      <p class="mb-1">
        <strong>Numéro:</strong> {{ selectedApplicationFileForClose.fileNumber || '#' + selectedApplicationFileForClose.id }}
      </p>
      <p class="mb-0">
        <strong>Statut actuel:</strong> 
        <c-badge [color]="selectedApplicationFileForClose.status === 'ACTIVE' || selectedApplicationFileForClose.status === 'IN_PROGRESS' || selectedApplicationFileForClose.status === 'COMPLETED' ? 'success' : 'secondary'">
          {{ 
            selectedApplicationFileForClose.status === 'ACTIVE' ? 'Actif' : 
            selectedApplicationFileForClose.status === 'IN_PROGRESS' ? 'En cours' :
            selectedApplicationFileForClose.status === 'COMPLETED' ? 'Réussi' :
            selectedApplicationFileForClose.status === 'CANCELLED' ? 'Annulé' :
            selectedApplicationFileForClose.status === 'GRADUATED' ? 'Diplômé' :
            selectedApplicationFileForClose.status === 'FAILED' ? 'Échoué' :
            'Expiré' 
          }}
        </c-badge>
      </p>
    </div>

    <div class="alert alert-success">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      <strong>Félicitations !</strong> Ce candidat est éligible pour la clôture du dossier.
      <ul class="mt-2 mb-0">
        <li>Les examens théorique et pratique ont été réussis</li>
        <li>Le dossier sera marqué comme "Diplômé"</li>
        <li>Le candidat pourra obtenir son permis de conduire</li>
      </ul>
    </div>

    <p>Êtes-vous sûr de vouloir clôturer ce dossier de candidature ?</p>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeCloseApplicationFileModal()">
      Annuler
    </button>
    <button 
      cButton 
      color="success" 
      (click)="onCloseApplicationFile()"
      [disabled]="loading"
      class="d-flex align-items-center text-white">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Oui, clôturer le dossier
    </button>
  </c-modal-footer>
</c-modal>

<!-- Edit Hours Modal -->
<c-modal 
  [visible]="showEditHoursModal" 
  (visibleChange)="showEditHoursModal = $event"
  [keyboard]="false"
  [backdrop]="'static'">
  <c-modal-header>
    <h4 cModalTitle>
      <svg cIcon name="cilClock" class="me-2"></svg>
      Modifier les {{ editingHoursType === 'theoretical' ? 'heures théoriques' : 'heures pratiques' }}
    </h4>
    <button 
      type="button" 
      class="btn-close" 
      aria-label="Close"
      (click)="closeEditHoursModal()">
    </button>
  </c-modal-header>
  
  <c-modal-body>
    <c-alert *ngIf="modalSuccess" color="success" [dismissible]="true">
      <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      {{ modalSuccess }}
    </c-alert>

    <c-alert *ngIf="modalError" color="danger" [dismissible]="true">
      <svg cIcon name="cilWarning" class="me-2"></svg>
      {{ modalError }}
    </c-alert>

    <!-- Application File Info -->
    <div *ngIf="selectedApplicationFileForHours" class="alert alert-info mb-3">
      <h6 class="mb-2">
        <svg cIcon name="cilInfo" class="me-2"></svg>
        Dossier de candidature
      </h6>
      <div class="row g-2">
        <div class="col-md-6">
          <strong>Catégorie:</strong> {{ selectedApplicationFileForHours.category }}
        </div>
        <div class="col-md-6">
          <strong>Dossier:</strong> {{ selectedApplicationFileForHours.fileNumber || '#' + selectedApplicationFileForHours.id }}
        </div>
      </div>
    </div>

    <form [formGroup]="editHoursForm" cForm>
      <c-row class="g-3">
        <c-col md="12">
          <label cLabel for="hours">
            {{ editingHoursType === 'theoretical' ? 'Heures théoriques' : 'Heures pratiques' }} *
          </label>
          <c-input-group>
            <input 
              cFormControl 
              id="hours" 
              type="number" 
              step="1"
              min="0"
              max="50"
              formControlName="hours"
              placeholder="Ex: 15"
              [class.is-invalid]="isFieldInvalid(editHoursForm, 'hours')">
            <span cInputGroupText>heures</span>
          </c-input-group>
          <c-form-feedback 
            *ngIf="isFieldInvalid(editHoursForm, 'hours')" 
            [valid]="false">
            {{ getFieldError(editHoursForm, 'hours') }}
          </c-form-feedback>
          <small class="form-text text-muted">
            Entrez le nombre d'heures {{ editingHoursType === 'theoretical' ? 'théoriques' : 'pratiques' }} complétées (20h minimum requis pour les examens)
          </small>
        </c-col>
      </c-row>
    </form>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="secondary" 
      (click)="closeEditHoursModal()">
      Annuler
    </button>
    <button 
      cButton 
      color="primary" 
      (click)="onSubmitEditHours()"
      [disabled]="loading">
      <c-spinner *ngIf="loading" size="sm" class="me-2"></c-spinner>
      Mettre à jour
    </button>
  </c-modal-footer>
</c-modal>

</div>